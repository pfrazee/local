!function(){function e(e){return e&&"function"==typeof e.then}function t(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function n(t,n,r){if(null===r)t.isRejected()?n.reject(t.value):n.fulfill(t.value);else{var o;try{o=r(t.value)}catch(s){s instanceof Error&&(console.error?console.error(s,s.stack):console.log("Promise exception thrown",s,s.stack)),n.reject(s)}e(o)?i(o).chain(n):n.fulfill(o)}}function r(e,t){Array.isArray(e)||(e=[e]);var n=i(),r=e.length,o=0;if(0===r)return n.fulfill([]),n;var s=[];s.length=r;for(var a=[],l=function(e,i,l){s[i]=e,l&&a.push(i),++o==r&&(t?t(s,a)?n.fulfill(s):n.reject(s):n.fulfill(s))},c=0;r>c;c++)i(e[c]).succeed(l,c,!1).fail(l,c,!0);return n}function o(e){return r(e,function(e,t){return 0===t.length})}function s(e){return r(e,function(e,t){return t.length<e.length})}function i(n){if(arguments.length>1)return r(Array.prototype.slice.call(arguments));if(n instanceof t)return n;if(e(n)){var o=i();return n.then(function(e){o.fulfill(e)},function(e){o.reject(e)}),o}return new t(n)}var a=this;"undefined"!=typeof window?("undefined"==typeof window.local&&(window.local={}),a=window.local):"undefined"!=typeof self?("undefined"==typeof self.local&&(self.local={}),a=self.local):"undefined"!=typeof module&&(a=module.exports),t.prototype.isUnfulfilled=function(){return!this.__hasValue},t.prototype.isRejected=function(){return this.__hasFailed},t.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},t.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var r=i();if(this.isUnfulfilled())this.succeedCBs.push({p:r,fn:e}),this.failCBs.push({p:r,fn:t});else{var o=this;setTimeout(function(){o.isFulfilled()?n(o,r,e):n(o,r,t)},0)}return r},t.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(n){return e.apply(null,[n].concat(t))})},t.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(n){return e.apply(null,[n].concat(t))})},t.prototype.always=function(e){return this.then(e,e)},t.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var r=this.succeedCBs[t];n(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var r=this.failCBs[t];n(this,r.p,r.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},t.prototype.chain=function(e){return this.then(function(t){return i(e).fulfill(t),t},function(t){return i(e).reject(t),t}),e},t.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},a.Promise=t,a.promise=i,a.promise.bundle=r,a.promise.all=o,a.promise.any=s}(),"undefined"!=typeof define&&define([],function(){return Promise}),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.util&&(this.local.util={}),function(){function e(){Object.defineProperty(this,"_events",{value:{},configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_suspensions",{value:0,configurable:!1,enumerable:!1,writable:!0}),Object.defineProperty(this,"_history",{value:[],configurable:!1,enumerable:!1,writable:!0})}e.prototype.suspendEvents=function(){this._suspensions++},e.prototype.resumeEvents=function(){this._suspensions--,this._suspensions<=0&&this.playbackHistory()},e.prototype.isSuspended=function(){return this._suspensions>0},e.prototype.playbackHistory=function(){for(var e;!this.isSuspended()&&(e=this._history.shift());)this.emit.apply(this,e)},e.prototype.emit=function(e){var t=Array.prototype.slice.call(arguments);if(this.isSuspended())return this._history.push(t),void 0;var n=this._events[e];if(!n)return!1;t=t.slice(1);for(var r=0,o=n.length;o>r;r++)n[r].apply(this,t);return!0},e.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var n=this;n.on(e,function r(){n.removeListener(e,r),t.apply(this,arguments)})},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var n=this._events[e],r=n.indexOf(t);return 0>r?this:(n.splice(r,1),0===n.length&&delete this._events[e],this)},e.prototype.removeAllListeners=function(e){return e?this._events[e]=null:this._events={},this._history[e]&&(this._history[e]=null),this},e.prototype.listeners=function(e){return this._events[e]},local.util.EventEmitter=e}(),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.web&&(this.local.web={}),function(){function e(e){var t=e.match(/\s*(\S+)\/([^;\s]+)\s*(?:;(.*))?/);if(!t)return null;var n=t[1],r=t[2],o=""+n+"/"+r,s={},i=1;return t[3]&&(s=t[3].split(";").map(function(e){return e.trim().split("=")}).reduce(function(e,t){return e[t[0]]=t[1],e},s),null!==s.q&&(i=parseFloat(s.q),delete s.q)),{type:n,subtype:r,params:s,q:i,full:o}}function t(e,t){var n=t.filter(function(t){return r(e,t)}).sort(function(e,t){return e.q>t.q?-1:1});return n[0]?n[0].q:0}function n(e,t){return"*"===e||e===t}function r(t,r){var o=e(t);if(r.params){var s=Object.keys(r.params);if(s.some(function(e){return!n(r.params[e],o.params[e])}))return null}return n(r.type,o.type)&&n(r.subtype,o.subtype)?r:void 0}function o(e,t){if(!e||"object"!=typeof e||!t)return e;var n=l(t,"serializer");return n?n(e):e}function s(e,t){if(!e||"string"!=typeof e||!t)return e;var n=l(t,"deserializer");if(!n)return e;try{return n(e)}catch(r){return console.warn("Failed to deserialize content",t,e),e}}function i(e,t,n){_[e]={serializer:t,deserializer:n}}function a(e){var t=e.split(";"),n=t[0];if(t=n.split("/"),t[1]){var r=t[1].split("+");return r[1]?[n,t[0]+"/"+r[1],t[0]]:[n,t[0]]}return[n]}function l(e,t){for(var n=a(e),r=0;r<n.length;r++)if(n[r]in _)return _[n[r]][t];return null}function c(e){var t=e.indexOf(":");return[e.slice(0,t).trim(),e.slice(t+1).trim()]}function u(e){local.util.EventEmitter.call(this),e||(e={}),"string"==typeof e&&(e={url:e}),this.method=e.method?e.method.toUpperCase():"GET",this.url=e.url||null,this.query=e.query||{},this.headers=e.headers||{},this.body="",Object.defineProperty(this,"body",{value:"",configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"stream",{value:e.stream||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"binary",{value:e.binary||!1,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),function(e){e.on("data",function(t){e.body+=t}),e.on("end",function(){e.headers["content-type"]&&(e.body=local.web.contentTypes.deserialize(e.body,e.headers["content-type"])),e.body_.fulfill(e.body)})}(this)}function h(){local.util.EventEmitter.call(this),this.status=0,this.reason=null,this.headers={},this.body="",Object.defineProperty(this,"isConnOpen",{value:!0,configurable:!0,enumerable:!1,writable:!0}),Object.defineProperty(this,"body_",{value:local.promise(),configurable:!0,enumerable:!1,writable:!1}),function(e){e.on("data",function(t){t instanceof ArrayBuffer?e.body=t:e.body+=t}),e.on("end",function(){e.headers["content-type"]&&(e.body=local.web.contentTypes.deserialize(e.body,e.headers["content-type"])),e.body_.fulfill(e.body)})}(this)}function p(e,t){if(e&&Array.isArray(e))for(var n=0,r=e.length;r>n;n++)p(e[n],t);else C[e]=t}function f(e){delete C[e]}function d(e){return C[e]}function g(e){try{var t=e.url.indexOf(":"),n=e.url.slice(t+1).split("|")}catch(r){return console.warn("Failed to parse proxy URL",e.url,r),response.writeHead(0,"invalid proxy URL").end()}var o=n.shift(),s=null;return n[0]?(s=n[1]?"proxy:"+n.join("|"):n[0],e.url=o,e.headers["proxy-to"]=s,e.headers["proxy-method"]=e.method,e.method="PROXY"):e.url=o,t=e.url.indexOf(":"),e.url.slice(0,t)}function v(e,t){local.util.EventEmitter.call(this),this.request=e,this.response=null,this.lastEventId=-1,this.isConnOpen=!0,this.connect(t)}function m(e){this.emit("message",e),this.emit("error",e)}function y(e){e=local.web.contentTypes.deserialize(e,"text/event-stream");var t=parseInt(e.id,10);"undefined"!=typeof t&&t>this.lastEventId&&(this.lastEventId=t),this.emit("message",e),this.emit(e.event,e)}function b(){this.streams=[]}function w(){return"undefined"!=typeof window?window.location.host:app?app.config.environmentHost:""}function x(e,t,n){this.rel=e,this.relparams=t,this.url=n,this.resolveState=x.UNRESOLVED,this.error=null}function E(e,t){if(this.context=e||null,this.parentNavigator=t||null,this.links=null,this.authHeader=null,"string"==typeof this.context)this.context=new x(null,null,e);else if(!t)throw"parentNavigator is required for navigators with relative contexts"}local.web.parseLinkHeader=function(e){return"string"!=typeof e?e:e.split(/,[\s]*/g).map(function(e){var t={};return e.split(/\s*;\s*/g).forEach(function(e){if(e)if("<"===e.charAt(0))t.href=e.trim().slice(1,-1);else{var n=e.split(/\s*=\s*/g);if(n[1]){var r=n[0],o=n[1].replace(/^"|"$/g,"");t[r]=o}else{var r=n[0];t[r]=!0}}}),t})},local.web.lookupLink=function(e,t,n){var r=e?e.length:0;if(!r)return null;n&&(n=n.toLowerCase());for(var o=RegExp("\\b"+t+"\\b"),s=null,i=0;r>i;i++){var a=e[i];if(a&&o.test(a.rel))if(n&&a.id){if(a.id.toLowerCase()===n){s=a;break}}else s=a}return s?s.href:null},local.web.queryLinks=function(e,t){return e?(e.headers&&(e=e.headers.link),Array.isArray(e)?e.filter(function(e){return local.web.queryLink(e,t)}):[]):[]},local.web.queryLinks1=function(e,t){var n=local.web.queryLinks(e,t);return n[0]},local.web.queryLink=function(e,t){for(var n in t)if("rel"==n)for(var r=t.rel.split(/\s+/),o=0;o<r.length;o++){var s=!0;if("!"==r[o].charAt(0)&&(r[o]=r[o].slice(1),s=!1),RegExp("(\\s|^)(.*//)?"+r[o]+"(\\s|$)","i").test(e.rel)!==s)return!1}else if(e[n]!=t[n])return!1;return!0},local.web.parseAcceptHeader=function(t){return t.split(",").map(function(t){return e(t.trim())}).filter(function(e){return e&&e.q>0})},local.web.preferredTypes=function(e,n){return"object"==typeof e&&(e=e.headers.accept),e=local.web.parseAcceptHeader(e||""),n?n.map(function(n){return[n,t(n,e)]}).filter(function(e){return e[1]>0}).sort(function(e,t){return e[1]===t[1]?0:e[1]>t[1]?-1:1}).map(function(e){return e[0]}):e.map(function(e){return e.full})},local.web.preferredType=function(e,t){return local.web.preferredTypes(e,t)[0]},local.web.joinUrl=function(){var e=Array.prototype.map.call(arguments,function(e,t){e=""+e;var n=0,r=e.length;return"/"==e?"":(0!==t&&"/"===e.charAt(0)&&(n+=1),"/"===e.charAt(r-1)&&(r-=1),e.substring(n,r))});return e.join("/")},local.web.parseUri=function(e){if("object"==typeof e&&(e.url?e=e.url:(e.host||e.path)&&(e=local.web.joinUrl(req.host,req.path))),"data:"==e.slice(0,5))return{protocol:"data",source:e};for(var t=local.web.parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},o=14;o--;)r[t.key[o]]=n[o]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,o){n&&(r[t.q.name][n]=o)}),r},local.web.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},local.web.pipe=function(e,t,n,r){return n=n||function(e){return e},r=r||function(e){return e},local.promise(t).succeed(function(t){return e.status||e.writeHead(t.status,t.reason,n(t.headers)),null!==t.body&&"undefined"!=typeof t.body&&e.write(r(t.body)),t.on&&t.isConnOpen?(t.on("data",function(t){e.write(r(t))}),t.on("end",function(){e.end()})):e.end(),e}).fail(function(t){var n=t.headers["content-type"]||"text/plain",r=n&&t.body?t.body:"";throw e.writeHead(502,"bad gateway",{"content-type":n}),e.end(r),t})};var R={serialize:o,deserialize:s,register:i},_={};local.web.contentTypes=R,local.web.contentTypes.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),local.web.contentTypes.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,n=[];for(var r in e)if(null===e[r])n.push(r+"=");else if(Array.isArray(e[r]))for(var o=0;o<e[r].length;o++)n.push(r+"[]="+t(e[r][o]));else if("object"==typeof e[r])for(var s in e[r])n.push(r+"["+s+"]="+t(e[r][s]));else n.push(r+"="+t(e[r]));return n.join("&")},function(e){for(var t=e.split("&"),n={},r=0;r<t.length;r++){var o=t[r].split("="),s=decodeURIComponent(o[0]),i=decodeURIComponent(o[1]),a=/\[\]$/.test(s),l=s.match(/^(.+)\[([^\]]+)\]$/);if(l){s=l[1];var c=l[2];n[s]=n[s]||{},n[s][c]=i}else a?(s=s.substring(0,s.length-2),n[s]=n[s]||[],n[s].push(i)):n[s]=i}return n}),local.web.contentTypes.register("text/event-stream",function(e){return"event: "+e.event+"\r\ndata: "+JSON.stringify(e.data)+"\r\n\r\n"},function(e){var t={};e.split("\r\n").forEach(function(e){/^[\s]*$/.test(e)||(e=c(e),e[0]&&(t[e[0]]=e[1]))});try{t.data=JSON.parse(t.data)}catch(n){}return t}),local.web.Request=u,u.prototype=Object.create(local.util.EventEmitter.prototype),u.prototype.setHeader=function(e,t){this.headers[e]=t},u.prototype.getHeader=function(e){return this.headers[e]},u.prototype.removeHeader=function(e){delete this.headers[e]},u.prototype.setTimeout=function(e){var t=this;setTimeout(function(){t.isConnOpen&&t.close()},e)},u.prototype.serializeHeaders=function(){if(this.headers.authorization&&"object"==typeof this.headers.authorization){if(!this.headers.authorization.scheme)throw"`scheme` required for auth headers";var e;switch(this.headers.authorization.scheme.toLowerCase()){case"basic":e="Basic "+btoa(this.headers.authorization.name+":"+this.headers.authorization.password);break;case"persona":e="Persona name="+this.headers.authorization.name+" assertion="+this.headers.authorization.assertion;break;default:throw"unknown auth sceme: "+this.headers.authorization.scheme}this.headers.authorization=e}if(this.headers.via&&"object"==typeof this.headers.via){var t=this.headers.via;Array.isArray(t)||(t=[t]),this.headers.via=t.map(function(e){return[(e.protocol.name?e.protocol.name+"/":"")+e.protocol.version,e.host,e.comment?e.comment:""].join(" ")}).join(", ")}},u.prototype.write=function(e){this.isConnOpen&&("string"!=typeof e&&(e=local.web.contentTypes.serialize(e,this.headers["content-type"])),this.emit("data",e))},u.prototype.end=function(e){this.isConnOpen&&("undefined"!=typeof e&&this.write(e),this.emit("end"))},u.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"))},local.web.Response=h,h.prototype=Object.create(local.util.EventEmitter.prototype),h.prototype.setHeader=function(e,t){this.headers[e]=t},h.prototype.getHeader=function(e){return this.headers[e]},h.prototype.removeHeader=function(e){delete this.headers[e]},h.prototype.writeHead=function(e,t,n){if(this.status=e,this.reason=t,n)for(var r in n)n.hasOwnProperty(r)&&this.setHeader(r,n[r]);return this.emit("headers",this),this},h.prototype.write=function(e){this.isConnOpen&&("string"!=typeof e&&(e=local.web.contentTypes.serialize(e,this.headers["content-type"])),this.emit("data",e))},h.prototype.end=function(e){this.isConnOpen&&("undefined"!=typeof e&&this.write(e),this.emit("end"),this.close())},h.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"))};var k={register:p,unregister:f,get:d},C={};local.web.schemes=k,local.web.schemes.register(["http","https"],function(e,t){var n=local.web.parseUri(e.url);if(e.query){var r=local.web.contentTypes.serialize(e.query,"application/x-www-form-urlencoded");r&&(n.query?(n.query+="&"+r,n.relative+="&"+r):(n.query=r,n.relative+="?"+r))}var o=(n.protocol?n.protocol+"://":"")+n.authority+n.relative,s=new XMLHttpRequest;s.open(e.method,o,!0),e.binary&&(s.responseType="arraybuffer",e.stream&&console.warn("Got HTTP/S request with binary=true and stream=true - sorry, not supported, binary responses must be buffered (its a browser thing)",e)),e.serializeHeaders();for(var i in e.headers)null!==e.headers[i]&&e.headers.hasOwnProperty(i)&&s.setRequestHeader(i,e.headers[i]);var a="";e.on("data",function(e){a+=e}),e.on("end",function(){s.send(a)}),e.on("close",function(){s.readyState!==XMLHttpRequest.DONE&&s.abort()});var l=0,c=0,u=!1;s.onreadystatechange=function(){if(s.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!u){u=!0;var e={};if(0!==s.status){if(s.getAllResponseHeaders())s.getAllResponseHeaders().split("\n").forEach(function(t){if(t){var n=t.replace("\r","").split(": ");e[n[0].toLowerCase()]=n[1]}});else{var n=function(t){var n=s.getResponseHeader(t);n&&(e[t.toLowerCase()]=n.toLowerCase())};n("Accept-Ranges"),n("Age"),n("Allow"),n("Cache-Control"),n("Connection"),n("Content-Encoding"),n("Content-Language"),n("Content-Length"),n("Content-Location"),n("Content-MD5"),n("Content-Disposition"),n("Content-Range"),n("Content-Type"),n("Date"),n("ETag"),n("Expires"),n("Last-Modified"),n("Link"),n("Location"),n("Pragma"),n("Refresh"),n("Retry-After"),n("Server"),n("Set-Cookie"),n("Trailer"),n("Transfer-Encoding"),n("Vary"),n("Via"),n("Warning"),n("WWW-Authenticate")}e.link&&(e.link=local.web.parseLinkHeader(e.link))}t.writeHead(s.status,s.statusText,e),t.binary||(l=setInterval(function(){var e=s.response.length;if(e>c){var n=s.response.slice(c);c=e,t.write(n)}},50))}s.readyState===XMLHttpRequest.DONE&&(l&&clearInterval(l),0!==t.status&&0===s.status?(console.debug("XHR looks like it timed out; treating it as a premature close"),t.close()):(s.response&&t.write(s.response.slice(c)),t.end()))}});var L={fn:function(e,t){t.writeHead(404,"server not found"),t.end()},context:null};local.web.schemes.register("httpl",function(e,t){var n=local.web.parseUri(e.url);e.suspendEvents(),t.suspendEvents();var r=local.web.getLocal(n.host);if(r||(r=L),e.path=n.path,e.path=e.path?e.path.replace(/(.)\/$/,"$1"):"/",n.query){var o=local.web.contentTypes.deserialize(n.query,"application/x-www-form-urlencoded");for(var s in o)e.query[s]=o[s]}e.binary&&console.warn("Got HTTPL request with binary=true - sorry, not currently supported",e),setTimeout(function(){r.fn.call(r.context,e,t),e.resumeEvents(),t.resumeEvents()},0)}),local.web.schemes.register("data",function(e,t){for(var n,r=e.url.indexOf(":"),o=e.url.indexOf(","),s=e.url.slice(r+1,o).split(";"),i=s.shift(),a=!1;n=s.shift();)"base64"==n&&(a=!0);var l=e.url.slice(o+1);l||(l=""),l=a?atob(l):decodeURIComponent(l),setTimeout(function(){t.writeHead(200,"ok",{"content-type":i}),t.end(l)})});var A={};local.web.registerLocal=function(e,t,n){var r=local.web.parseUri(e);if(r.protocol&&"httpl"!==r.protocol)throw"registerLocal can only add servers to the httpl protocol";if(!r.host)throw"invalid domain provided to registerLocal";if(A[r.host])throw"server already registered at domain given to registerLocal";A[r.host]={fn:t,context:n}},local.web.unregisterLocal=function(e){var t=local.web.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";A[t.host]&&delete A[t.host]},local.web.getLocal=function(e){var t=local.web.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";return A[t.host]},local.web.getLocalRegistry=function(){return A};var q;local.web.dispatch=function(e){if(!e)throw"no request param provided to request";if("string"==typeof e&&(e={url:e}),!e.url)throw"no url on request";var t=null,n=!1;e instanceof local.web.Request||(t=e.body,e=new local.web.Request(e),n=!0);var r,o=e.url.indexOf(":");r=-1===o?"http":e.url.slice(0,o),"proxy"==r&&(r=g(e));var s=local.promise(),i=new local.web.Response;e.stream?i.on("headers",function(e){local.web.fulfillResponsePromise(s,e)}):i.on("close",function(){local.web.fulfillResponsePromise(s,i)}),e.suspendEvents(),i.suspendEvents();var a=Array.prototype.slice.call(arguments,1);return a.unshift(function(e,o,i){return i=i||local.web.schemes.get(r),i?(i(e,o),e.resumeEvents(),o.resumeEvents(),n&&e.end(t)):(o.writeHead(0,'unsupported scheme "'+r+'"'),o.end()),s}),a.unshift(i),a.unshift(e),q.apply(null,a),s.request=e,s},local.web.fulfillResponsePromise=function(e,t){t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||0===t.status?e.reject(t):e.fulfill(t)},local.web.setDispatchWrapper=function(e){q=e},local.web.setDispatchWrapper(function(e,t,n){n(e,t)}),local.web.subscribe=function(e){"string"==typeof e&&(e={url:e}),e.stream=!0,e.method||(e.method="GET"),e.headers||(e.headers={accept:"text/event-stream"}),e.headers.accept||(e.headers.accept="text/event-stream");var t=local.web.dispatch(e);return new v(t.request,t)},local.web.EventStream=v,v.prototype=Object.create(local.util.EventEmitter.prototype),v.prototype.connect=function(e){var t=this;e.then(function(e){t.isConnOpen=!0,t.response=e,e.on("data",function(e){var n=e.split("\r\n\r\n");n.forEach(function(e){/^[\s]*$/.test(e)||y.call(t,e)})}),e.on("end",function(){t.close()}),e.on("close",function(){t.isConnOpen&&(t.isConnOpen=!1,t.reconnect())})},function(e){t.response=e,m.call(t,{event:"error",data:e}),t.close()})},v.prototype.reconnect=function(){this.isConnOpen&&this.close(),this.request=new local.web.Request(this.request),this.request.headers||(this.request.headers={}),this.lastEventId&&(this.request.headers["last-event-id"]=this.lastEventId),this.connect(local.web.dispatch(this.request)),this.request.end()},v.prototype.close=function(){this.isConnOpen=!1,this.request.close(),this.emit("close"),this.removeAllListeners()},local.web.Broadcaster=b,b.prototype.addStream=function(e){this.streams.push(e);var t=this;e.on("close",function(){t.endStream(e)})},b.prototype.endStream=function(e){this.streams=this.streams.filter(function(t){return t!=e}),e.end()},b.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},b.prototype.emit=function(e,t){this.streams.forEach(function(n){this.emitTo(n,e,t)},this)},b.prototype.emitTo=function(e,t,n){e.write({event:t,data:n})},local.web.broadcaster=function(){return new b},function(e){"use strict";function t(e){var n;if(null===e||void 0===e)return!1;if(r.isArray(e))return e.length>0;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;for(n in e)if(e.hasOwnProperty(n)&&t(e[n]))return!0;return!1}var n=function(){function e(e){this.options=e}return e.prototype.toString=function(){return JSON&&JSON.stringify?JSON.stringify(this.options):this.options},e}(),r=function(){function e(e){return"[object Array]"===Object.prototype.toString.apply(e)}function t(e){return"[object String]"===Object.prototype.toString.apply(e)}function n(e){return"[object Number]"===Object.prototype.toString.apply(e)}function r(e){return"[object Boolean]"===Object.prototype.toString.apply(e)}function o(e,t){var n,r="",o=!0;for(n=0;n<e.length;n+=1)o?o=!1:r+=t,r+=e[n];return r}function s(e,t){for(var n=[],r=0;r<e.length;r+=1)n.push(t(e[r]));return n}function i(e,t){for(var n=[],r=0;r<e.length;r+=1)t(e[r])&&n.push(e[r]);return n}function a(e){if("object"!=typeof e||null===e)return e;Object.freeze(e);var t,n;for(n in e)e.hasOwnProperty(n)&&(t=e[n],"object"==typeof t&&l(t));return e}function l(e){return"function"==typeof Object.freeze?a(e):e}return{isArray:e,isString:t,isNumber:n,isBoolean:r,join:o,map:s,filter:i,deepFreeze:l}}(),o=function(){function e(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function t(e){return e>="0"&&"9">=e}function n(e){return t(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}return{isAlpha:e,isDigit:t,isHexDigit:n}}(),s=function(){function e(e){return e.length>1?e:"0"+e}function t(t){var n,r,o="",s=a.encode(t);for(r=0;r<s.length;r+=1)n=s.charCodeAt(r),o+="%"+e(n.toString(16).toUpperCase());return o}function n(e,t){return"%"===e.charAt(t)&&o.isHexDigit(e.charAt(t+1))&&o.isHexDigit(e.charAt(t+2))}function r(e,t){return parseInt(e.substr(t,2),16)}function s(e){if(!n(e,0))return!1;var t=r(e,1),o=a.numBytes(t);if(0===o)return!1;for(var s=1;o>s;s+=1)if(!n(e,3*s)||!a.isValidFollowingCharCode(r(e,3*s+1)))return!1;return!0}function i(e,t){var o=e.charAt(t);if(!n(e,t))return o;var s=r(e,t+1),i=a.numBytes(s);if(0===i)return o;for(var l=1;i>l;l+=1)if(!n(e,t+3*l)||!a.isValidFollowingCharCode(r(e,t+3*l+1)))return o;return e.substr(t,3*i)}var a={encode:function(e){return unescape(encodeURIComponent(e))},numBytes:function(e){return 127>=e?1:e>=194&&223>=e?2:e>=224&&239>=e?3:e>=240&&244>=e?4:0},isValidFollowingCharCode:function(e){return e>=128&&191>=e}};return{encodeCharacter:t,isPctEncoded:s,pctCharAt:i}}(),i=function(){function e(e){return o.isAlpha(e)||o.isDigit(e)||"_"===e||s.isPctEncoded(e)}function t(e){return o.isAlpha(e)||o.isDigit(e)||"-"===e||"."===e||"_"===e||"~"===e}function n(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}return{isVarchar:e,isUnreserved:t,isReserved:n}}(),a=function(){function e(e,t){var n,r="",o="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),n=0;n<e.length;n+=o.length)o=e.charAt(n),r+=i.isUnreserved(o)||t&&i.isReserved(o)?o:s.encodeCharacter(o);return r}function t(t){return e(t,!0)}function n(e,t){var n=s.pctCharAt(e,t);return n.length>1?n:i.isReserved(n)||i.isUnreserved(n)?n:s.encodeCharacter(n)}function r(e){var t,n="",r="";for(t=0;t<e.length;t+=r.length)r=s.pctCharAt(e,t),n+=r.length>1?r:i.isReserved(r)||i.isUnreserved(r)?r:s.encodeCharacter(r);return n}return{encode:e,encodePassReserved:t,encodeLiteral:r,encodeLiteralCharacter:n}}(),l=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?a.encodePassReserved:a.encode,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){return t[e]?t[e]:"=,!@|".indexOf(e)>=0?null:t[""]}}}(),c=function(){function e(e){this.literal=a.encodeLiteral(e)}return e.prototype.expand=function(){return this.literal},e.prototype.toString=e.prototype.expand,e}(),u=function(){function e(e){function t(){var t=e.substring(f,c);if(0===t.length)throw new n({expressionText:e,message:"a varname must be specified",position:c});p={varname:t,exploded:!1,maxLength:null},f=null}function r(){if(d===c)throw new n({expressionText:e,message:"after a ':' you have to specify the length",position:c});p.maxLength=parseInt(e.substring(d,c),10),d=null}var a,c,u=[],p=null,f=null,d=null,g="";for(a=function(t){var r=l.valueOf(t);if(null===r)throw new n({expressionText:e,message:"illegal use of reserved operator",position:c,operator:t});return r}(e.charAt(0)),c=a.symbol.length,f=c;c<e.length;c+=g.length){if(g=s.pctCharAt(e,c),null!==f){if("."===g){if(f===c)throw new n({expressionText:e,message:"a varname MUST NOT start with a dot",position:c});continue}if(i.isVarchar(g))continue;t()}if(null!==d){if(c===d&&"0"===g)throw new n({expressionText:e,message:"A :prefix must not start with digit 0",position:c});if(o.isDigit(g)){if(c-d>=4)throw new n({expressionText:e,message:"A :prefix must have max 4 digits",position:c});continue}r()}if(":"!==g)if("*"!==g){if(","!==g)throw new n({expressionText:e,message:"illegal character",character:g,position:c});u.push(p),p=null,f=c+1}else{if(null===p)throw new n({expressionText:e,message:"exploded without varspec",position:c});if(p.exploded)throw new n({expressionText:e,message:"exploded twice",position:c});if(p.maxLength)throw new n({expressionText:e,message:"an explode (*) MUST NOT follow to a prefix",position:c});p.exploded=!0}else{if(null!==p.maxLength)throw new n({expressionText:e,message:"only one :maxLength is allowed per varspec",position:c});if(p.exploded)throw new n({expressionText:e,message:"an exploeded varspec MUST NOT be varspeced",position:c});d=c+1}}return null!==f&&t(),null!==d&&r(),u.push(p),new h(e,a,u)}function t(t){var r,o,s=[],i=null,a=0;for(r=0;r<t.length;r+=1)if(o=t.charAt(r),null===a){if(null===i)throw new Error("reached unreachable code");if("{"===o)throw new n({templateText:t,message:"brace already opened",position:r});if("}"===o){if(i+1===r)throw new n({templateText:t,message:"empty braces",position:i});try{s.push(e(t.substring(i+1,r)))}catch(l){if(l.prototype===n.prototype)throw new n({templateText:t,message:l.options.message,position:i+l.options.position,details:l.options});throw l}i=null,a=r+1}}else{if("}"===o)throw new n({templateText:t,message:"unopened brace closed",position:r});"{"===o&&(r>a&&s.push(new c(t.substring(a,r))),a=null,i=r)}if(null!==i)throw new n({templateText:t,message:"unclosed brace",position:i});return a<t.length&&s.push(new c(t.substr(a))),new p(t,s)}return t}(),h=function(){function e(e){return JSON&&JSON.stringify?JSON.stringify(e):e}function n(e){if(!t(e))return!0;if(r.isString(e))return""===e;if(r.isNumber(e)||r.isBoolean(e))return!1;if(r.isArray(e))return 0===e.length;for(var n in e)if(e.hasOwnProperty(n))return!1;return!0}function o(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push({name:t,value:e[t]});return n}function s(e,t,n){this.templateText=e,this.operator=t,this.varspecs=n}function i(e,t,n){var r="";if(n=n.toString(),t.named){if(r+=a.encodeLiteral(e.varname),""===n)return r+=t.ifEmpty;r+="="}return null!==e.maxLength&&(n=n.substr(0,e.maxLength)),r+=t.encode(n)}function l(e){return t(e.value)}function c(e,s,i){var c=[],u="";if(s.named){if(u+=a.encodeLiteral(e.varname),n(i))return u+=s.ifEmpty;u+="="}return r.isArray(i)?(c=i,c=r.filter(c,t),c=r.map(c,s.encode),u+=r.join(c,",")):(c=o(i),c=r.filter(c,l),c=r.map(c,function(e){return s.encode(e.name)+","+s.encode(e.value)}),u+=r.join(c,",")),u}function u(e,s,i){var c=r.isArray(i),u=[];return c?(u=i,u=r.filter(u,t),u=r.map(u,function(t){var r=a.encodeLiteral(e.varname);return r+=n(t)?s.ifEmpty:"="+s.encode(t)})):(u=o(i),u=r.filter(u,l),u=r.map(u,function(e){var t=a.encodeLiteral(e.name);return t+=n(e.value)?s.ifEmpty:"="+s.encode(e.value)})),r.join(u,s.separator)}function h(e,n){var s=[],i="";return r.isArray(n)?(s=n,s=r.filter(s,t),s=r.map(s,e.encode),i+=r.join(s,e.separator)):(s=o(n),s=r.filter(s,function(e){return t(e.value)}),s=r.map(s,function(t){return e.encode(t.name)+"="+e.encode(t.value)}),i+=r.join(s,e.separator)),i}return s.prototype.toString=function(){return this.templateText},s.prototype.expand=function(o){var s,a,l,p,f=[],d=!1,g=this.operator;for(s=0;s<this.varspecs.length;s+=1)if(a=this.varspecs[s],l=o[a.varname],null!==l&&void 0!==l)if(a.exploded&&(d=!0),p=r.isArray(l),"string"==typeof l||"number"==typeof l||"boolean"==typeof l)f.push(i(a,g,l));else{if(a.maxLength&&t(l))throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+e(l));a.exploded?t(l)&&(g.named?f.push(u(a,g,l)):f.push(h(g,l))):(g.named||!n(l))&&f.push(c(a,g,l))}return 0===f.length?"":g.first+r.join(f,g.separator)},s}(),p=function(){function e(e,t){this.templateText=e,this.expressions=t,r.deepFreeze(this)
}return e.prototype.toString=function(){return this.templateText},e.prototype.expand=function(e){var t,n="";for(t=0;t<this.expressions.length;t+=1)n+=this.expressions[t].expand(e);return n},e.parse=u,e.UriTemplateError=n,e}();e(p)}(function(e){"use strict";local.web.UriTemplate=e});var S=["head","post","put","patch","delete"],T={Json:"application/json",Html:"text/html",Xml:"text/xml",Events:"text/event-stream",Eventstream:"text/event-stream",Plain:"text/plain",Text:"text/plain"},O=["alternate","author","collection","current","describedby","first","index","item","last","latest-version","monitor","monitor-group","next","next-archive","payment","predecessor-version","prev","prev-archive","related","replies","search","self","service","successor-version","up","version-history","via","working-copy","working-copy-of"];x.UNRESOLVED=0,x.RESOLVED=1,x.FAILED=2,x.prototype.isResolved=function(){return this.resolveState===x.RESOLVED},x.prototype.isBad=function(){return this.resolveState>1},x.prototype.isRelative=function(){return!this.url&&!!this.rel},x.prototype.isAbsolute=function(){return!!this.url},x.prototype.getUrl=function(){return this.url},x.prototype.getError=function(){return this.error},x.prototype.getHost=function(){if(!this.host){if(!this.url)return null;var e=local.web.parseUri(this.url);this.host=(e.protocol||"http")+"://"+(e.authority||w())}return this.host},x.prototype.resetResolvedState=function(){this.resolveState=x.UNRESOLVED,this.error=null},x.prototype.resolve=function(e){this.error=null,this.resolveState=x.RESOLVED,this.url=e;var t=local.web.parseUri(this.url);this.host=(t.protocol||"http")+"://"+t.authority},local.web.Navigator=E,E.prototype.setAuthHeader=function(e){this.authHeader=e},E.prototype.dispatch=function(e){if(!e||!e.method)throw"request options not provided";e.headers||(e.headers={});var t=this;!e.headers.authorization&&this.authHeader&&(e.headers.authorization=this.authHeader);var n=local.promise();return(e.noresolve?local.promise(this.context.getUrl()):this.resolve({retry:e.retry,nohead:!0})).succeed(function(t){return e.url=t,local.web.dispatch(e)}).succeed(function(e){return t.context.error=null,t.context.resolveState=x.RESOLVED,t.links=e.headers.link?e.headers.link:t.links||[],e}).fail(function(e){throw 404===e.status&&(t.context.error=e,t.context.resolveState=x.FAILED),e}).chain(n),n},E.prototype.subscribe=function(e){var t=this;return e||(e={}),e.headers||(e.headers={}),this.resolve().succeed(function(n){return e.url=n,!e.headers.authorization&&t.authHeader&&(e.headers.authorization=t.authHeader),local.web.subscribe(e)})},E.prototype.relation=function(e,t,n){var r=n||{};r.id=(t||"").toLowerCase();var o=new E(new x(e,r),this);return this.authHeader&&o.setAuthHeader(this.authHeader),o},E.prototype.resolve=function(e){var t=this;e=e||{};var n=e.nohead;delete e.nohead;var r=local.promise();return null!==this.links&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1)?r.fulfill(this.context.getUrl()):this.context.isBad()===!1||this.context.isBad()&&e.retry?(this.context.resetResolvedState(),this.parentNavigator?this.parentNavigator.__resolveChild(this,e).succeed(function(){return n?!0:t.head(null,null,null,{noresolve:!0})}).succeed(function(){return t.context.getUrl()}).chain(r):(n?local.promise(!0):this.head(null,null,null,{noresolve:!0})).succeed(function(){return t.context.getUrl()}).chain(r)):r.reject(this.context.getError()),r},E.prototype.__resolveChild=function(e,t){var n=this,r=local.promise();return this.resolve(t).then(function(){var t=n.__lookupLink(e.context);if(t)e.context.resolve(t),r.fulfill(t);else{var o=new local.web.Response;o.writeHead(404,"link relation not found").end(),r.reject(o)}},function(t){return e.context.error=t,e.context.resolveState=x.FAILED,r.reject(t),t}),r},E.prototype.__lookupLink=function(e){var t=local.web.lookupLink(this.links,e.rel,e.relparams.id);if(t){var n=local.web.UriTemplate.parse(t).expand(e.relparams),r=local.web.parseUri(n);return r.host||(n=this.context.getHost()+r.relative),n}return console.log("Failed to find a link to resolve context. Target link:",e.rel,e.relparams,"Navigator:",this),null},S.forEach(function(e){E.prototype[e]=function(t,n,r,o){var s=o||{};return s.headers=r||{},s.method=e,null!==t&&"null"!=typeof t&&/head/i.test(e)===!1&&(s.headers["content-type"]=n||("object"==typeof t?"application/json":"text/plain")),s.body=t,this.dispatch(s)}}),E.prototype.get=function(e,t,n){var r=n||{};return r.headers=t||{},r.method="get",r.headers.accept=e,this.dispatch(r)};for(var H in T)!function(e,t){E.prototype["get"+e]=function(e,n){return this.get(t,e,n)}}(H,T[H]);O.forEach(function(e){var t=e.replace(/-/g,"_");E.prototype[t]=function(t,n){return this.relation(e,t,n)}}),local.web.navigator=function(e,t,n){if(e instanceof E)return e;var r;return r=Array.isArray(e)?local.web.lookupLink(e,t,n):e,new E(r)}}(),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.client&&(this.local.client={}),function(){function e(e,t){for(;e;){if(t(e))return e;e=e.parentNode}return null}function t(){for(var e,n=Array.prototype.slice.call(arguments),r={};n.length;)if(e=n.shift())for(var o in e)"undefined"!=typeof e[o]&&null!==e[o]&&(r[o]="object"!=typeof e[o]||Array.isArray(e[o])?e[o]:t(r[o],e[o]));return r}function n(e,t){var n=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});e.dispatchEvent(n)}function r(t){var n=e.thatisFormRelated(t);if(n){for(var r=0;r<n.form.length;r++)n.form[r].setAttribute("submitter",null);n.setAttribute("submitter","1")}}function o(n,r){var i={form:{},fieldset:{},elem:{}},a=null,l=null;if("FIELDSET"===n.tagName?a=n:"FORM"!==n.tagName&&(a=e.byTag(n,"FIELDSET")),"FORM"===n.tagName)l=n;else{var c=n.getAttribute("form")||(a?a.getAttribute("form"):null);c&&(l=r.querySelector("#"+c)),l||(l=e.byTag(n,"FORM"))}var u=s(n,l);l&&(i.form=o.fromForm(l,n)),a&&(i.fieldset=o.fromFormElement(a)),"A"===n.tagName?i.elem=o.fromAnchor(n):-1===["FORM","FIELDSET"].indexOf(n.tagName)&&(i.elem=o.fromFormElement(n));var h=t(i.form,i.fieldset,i.elem),p={};return p[/GET/i.test(h.method)?"query":"body"]=u,t(h,p)}function s(t,n,r){r||(r={});var o={};r.nofiles||(o.__fileReads=[]);for(var s=0;s<n.length;s++){var a=n[s];if(a.name&&(!t||e.byElement(a,t))){var l="1"==a.getAttribute("submitter");if("BUTTON"===a.tagName)l&&(o[a.name]=a.value);else if("INPUT"===a.tagName)switch(a.type.toLowerCase()){case"button":case"submit":l&&(o[a.name]=a.value);break;case"checkbox":a.checked&&(o[a.name]=(o[a.name]||[]).concat(a.value));break;case"radio":null!==a.getAttribute("checked")&&(o[a.name]=a.value);break;case"file":if(r.nofiles)break;if(a.multiple){for(var c,s=0;c=a.files[s];s++)i(o,a,a.files[s],s);o[a.name]=[],o[a.name].length=s}else i(o,a,a.files[0]);break;default:o[a.name]=a.value}else o[a.name]=a.value}}return o}function i(e,t,n,r){if(n){var o=new FileReader;o.onloadend=a(e,t,n,r),o.readAsDataURL(n)}}function a(e,t,n,r){var o=local.promise();return e.__fileReads.push(o),function(e){var s={content:e.target.result||null,name:n.name,formattr:t.name,size:n.size,type:n.type,lastModifiedDate:n.lastModifiedDate};"undefined"!=typeof r&&(s.formindex=r),o.fulfill(s)}}function l(e){var t=e.body?e.body.__fileReads:e.query?e.query.__fileReads:[];return local.promise.bundle(t).then(function(t){return e.body&&delete e.body.__fileReads,e.query&&delete e.query.__fileReads,t.forEach(function(t){"undefined"!=typeof t.formindex?e.body[t.formattr][t.formindex]=t:e.body[t.formattr]=t}),e})}function c(e,t){e.__eventHandlers=[],t=t||{};var n;t.links!==!1&&(n={name:"click",handleEvent:h,container:e},e.addEventListener("click",n,!0),e.__eventHandlers.push(n)),t.forms!==!1&&(n={name:"submit",handleEvent:p,container:e},e.addEventListener("submit",n,!0))}function u(e){e.__eventHandlers&&(e.__eventHandlers.forEach(function(t){e.removeEventListener(t.name,t)}),delete e.__eventHandlers);var t=e.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(t,function(e){if(e.__subscriptions){for(var t in e.__subscriptions)e.__subscriptions[t].close();delete e.__subscriptions}})}function h(e){if(0===e.button){r(e.target);var t=o.fromAnchor(e.target);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),n(e.target,t),!1):void 0}}function p(e){var t=o(e.target,this.container);if(!t||-1===["_top","_blank"].indexOf(t.target))return t?(e.preventDefault(),e.stopPropagation(),l(t).then(function(){n(e.target,t)}),!1):void 0}function f(e,t,n){n.body=n.body||"";var r=n.headers["content-type"];if(/application\/html\-deltas\+json/.test(r))"object"==typeof n.body&&Array.isArray(n.body)?Array.isArray(n.body[0])?n.body.forEach(function(n){d(n,e,t)}):d(n.body,e,t):console.log("Improperly-formed application/html-deltas+json object",n);else{var o="";/text\/html/.test(r)?o=n.body.toString():(o="string"!=typeof n.body?JSON.stringify(n.body,null,2):n.body,o="<pre>"+o.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</pre>"),local.client.unlisten(e),e.innerHTML=o,local.env.postProcessRegion(e,t)}g(e,t),m(e,t)}function d(e,t,n){if("object"==typeof e&&Array.isArray(e)){var r,o,s,i=e.shift(),a=e.shift(),l=e;if(i&&a){var c=n.querySelectorAll(a),u=function(e){c[r].classList.add(e)},h=function(e){c[r].classList.remove(e)},p=function(e){c[r].classList.toggle(e)};for(r=0,o=c.length;o>r;r++)if(c[r]){var f=c[r];switch(i){case"replace":local.client.unlisten(f),f.innerHTML=l[0],local.env.postProcessRegion(f,n);break;case"remove":local.client.unlisten(f),f.parentNode.removeChild(f);break;case"append":f.innerHTML=f.innerHTML+l[0],local.env.postProcessRegion(f,n);break;case"prepend":f.innerHTML=l[0]+f.innerHTML,local.env.postProcessRegion(f,n);break;case"addClass":f.classList&&(l[0]||"").split(" ").forEach(u);break;case"removeClass":f.classList&&(l[0]||"").split(" ").forEach(h);break;case"toggleClass":f.classList&&(l[0]||"").split(" ").forEach(p);break;case"setAttribute":l[0]&&f.setAttribute(l[0],l[1]);break;case"navigate":s=local.env.getClientRegion(f.id),s?s.dispatchRequest(l[0]):console.log("html-delta navigate targeted non-client-region element",f,a)}}}}}function g(e,t){E.forEach(function(n){var r="on"+n,o=e.querySelectorAll("["+r+"]");Array.prototype.forEach.call(o,function(e){var o=e.getAttribute(r);e.addEventListener(n,v(o,t)),e.removeAttribute(r)})})}function v(e,r){return function(s){s.preventDefault(),s.stopPropagation();var i=o(s.currentTarget,r);i.method=e,l(i).then(function(){var r=/GET/i.test(e);r||i.body?r&&i.body&&(i.query=t(i.body,i.query),i.body={}):(i.body=i.query,i.query={}),n(s.target,i)})}}function m(e){var t=e.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(t,function(e){var t=e.dataset.subscribe.split(" "),n=t[0],r=t[1]||n;e.__subscriptions=e.__subscriptions||{};var o=e.__subscriptions[n];o||(o=e.__subscriptions[n]=local.web.subscribe({url:n}),o.on("update",y(r,e)),o.on("error",b()))})}function y(e,t){return function(){var r={method:"get",url:e,target:"_element",headers:{accept:"text/html"}};"FORM"==t.tagName&&(r.query=s(t,t,{nofiles:!0}),r.headers.accept=t.getAttribute("accept")||"text/html"),n(t,r)}}function b(){return function(e){var t=e.data;console.log("Client update stream error:",t)}}function w(e){if(this.id=e,this.context={url:"",urld:{},links:[],type:""},this.element=document.getElementById(e),!this.element)throw"Region target element not found";this.element.classList.add("client-region"),this.listenerFn=x.bind(this),this.element.addEventListener("request",this.listenerFn),local.client.listen(this.element)}function x(e){e.preventDefault(),e.stopPropagation();var t=e.detail;this.__prepareRequest(t);var n=this,r=function(r){n.__handleResponse(e,t,r)};local.web.dispatch(t,this).then(r,r)}e.byTag=function(t,n){return e(t,function(e){return e.tagName==n})},e.byClass=function(t,n){return e(t,function(e){return e.classList&&e.classList.contains(n)})},e.byElement=function(t,n){return e(t,function(e){return e===n})},e.thatisFormRelated=function(t){return e(t,function(e){return!!e.form})},o.fromAnchor=function(t){if(t=e.byTag(t,"A"),!t||!t.attributes.href||"#"==t.attributes.href.value.charAt(0))return null;var n={url:t.attributes.href.value,target:t.getAttribute("target"),headers:{accept:t.getAttribute("type")}};return n},o.fromFormElement=function(e){var t={method:e.getAttribute("formmethod"),url:e.getAttribute("formaction"),target:e.getAttribute("formtarget"),headers:{"content-type":e.getAttribute("formenctype"),accept:e.getAttribute("formaccept")}};return t},o.fromForm=function(e,n){if(n&&!n.form)for(var r=0;r<e.length;r++){var o=e[r];if("1"==o.getAttribute("submitter")){n=o,o.setAttribute("submitter","0");break}}var s={submitter:{},form:{}};n&&(s.submitter={method:n.getAttribute("formmethod"),url:n.getAttribute("formaction"),target:n.getAttribute("formtarget"),headers:{"content-type":n.getAttribute("formenctype"),accept:n.getAttribute("formaccept")}}),s.form={method:e.getAttribute("method"),url:e.getAttribute("action"),target:e.getAttribute("target"),headers:{"content-type":e.getAttribute("enctype")||e.enctype,accept:e.getAttribute("accept")}},e.acceptCharset&&(s.form.headers.accept=e.acceptCharset);var i=t(s.form,s.submitter);return i},local.client.findParentNode=e,local.client.extractRequest=o,local.client.extractRequestPayload=s,local.client.finishPayloadFileReads=l,local.client.listen=c,local.client.unlisten=u;var E=["blur","change","click","dblclick","focus","keydown","keypress","keyup","load","mousedown","mousemove","mouseout","mouseover","mouseup","reset","select","submit","unload"];local.client.renderResponse=f,"undefined"==typeof CustomEvent&&(CustomEvent=function(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n}),local.client.Region=w,w.prototype.dispatchRequest=function(e,t){"string"==typeof e&&(e={method:"get",url:e,headers:{accept:"text/html"}}),t||(t=this.element);var n=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:e});t.dispatchEvent(n)},w.prototype.terminate=function(){local.client.unlisten(this.element),this.element.removeEventListener("request",this.listenerFn)},w.prototype.__prepareRequest=function(e){e.headers=e.headers||{},e.headers.accept=e.headers.accept||"text/html",e.stream=!1;var t=local.web.parseUri(e);if(!t.protocol){var n;n=e.url.length>0&&"/"!=e.url.charAt(0)?this.context.urld.protocol+"://"+this.context.urld.host+this.context.urld.directory+e.url:this.context.urld.protocol+"://"+this.context.urld.host+e.url;var r=this.context.urld.host;do e.url=n,n=e.url.replace(/[^\/]+\/\.\.\//i,"");while(n!=e.url&&local.web.parseUri(n).host==r);delete e.host,delete e.path}},w.prototype.__handleResponse=function(e,t,n){n.headers=n.headers||{};var r=this.__chooseRequestTarget(e,t);if(r){var o=local.env.getClientRegion(r.id);switch(o&&o.__updateContext(t,n),n.status){case 204:break;case 205:"FORM"===r.tagName&&r.reset();break;case 303:var s={method:"get",url:n.headers.location,headers:{accept:"text/html"}};this.dispatchRequest(s);break;default:local.client.renderResponse(r,this.element,n)}}},w.prototype.__updateContext=function(e,t){var n=local.web.parseUri(e);this.context.urld=n,this.context.url=n.protocol+"://"+n.authority+n.directory,this.context.links=t.headers.link,this.context.type=t.headers["content-type"]},w.prototype.__chooseRequestTarget=function(e,t){return"_element"==t.target?e.target:document.getElementById(t.target)||this.element}}(),"undefined"==typeof this.local&&(this.local={}),"undefined"==typeof this.local.env&&(this.local.env={}),function(){!function(){function e(){return i++}function t(){return a++}function n(e){e=e||{},this.isLogging=e.log,this.isShared=e.shared,this.exchanges={},this.exchangeListeners={},this.ops=0,this.exchanges[this.ops]={topic:null,messageListeners:{}},this.suspendedTopics=[],this.messageBuffers={},this.isShared?(this.worker=new SharedWorker(e.bootstrapUrl||"worker.js",e.namespace),this.worker.port.start()):this.worker=new Worker(e.bootstrapUrl||"worker.js"),r.call(this)}function r(){this.getPort().addEventListener("message",function(e){var t=e.data;return t?"undefined"==typeof t.id?console.error("Invalid message from worker: `id` missing",t):"undefined"==typeof t.exchange?console.error("Invalid message from worker: `exchange` missing",t):t.label?(this.isLogging&&console.log("receiving",t),t.exchange=parseInt(t.exchange,10),t.exchange!==this.ops&&(t.exchange=-t.exchange),s.call(this,t),void 0):console.error("Invalid message from worker: `label` missing",t):console.error("Invalid message from worker: Payload missing",t)}.bind(this)),this.onMessage(this.ops,"open_exchange",function(e){return e.data?e.data.topic?"undefined"==typeof e.data.exchange?console.error('Invalid ops-exchange "open_exchange" message from worker: `exchange` missing',e):(this.isLogging&&console.log("open exchange",e),e.data.exchange=-parseInt(e.data.exchange,10),this.exchanges[e.data.exchange]={topic:e.data.topic,messageListeners:{},metaData:{}},o.call(this,e.data.topic,e.data.exchange),void 0):console.error('Invalid ops-exchange "open_exchange" message from worker: `topic` missing',e):console.error('Invalid ops-exchange "open_exchange" message from worker: Payload missing',e)}.bind(this)),this.onMessage(this.ops,"close_exchange",function(e){var t=-parseInt(e.data,10);return 0===t?console.error('Invalid ops-exchange "close_exchange" message from worker: Cannot close "ops" exchange',e):t?t in this.exchanges?(this.isLogging&&console.log("close exchange",e),this.removeAllMessageListeners(t),delete this.exchanges[t],t in this.messageBuffers&&delete this.messageBuffers[t],void 0):console.error('Invalid ops-exchange "close_exchange" message from worker: Invalid exchange id',e):console.error('Invalid ops-exchange "close_exchange" message from worker: Payload missing',e)}.bind(this))}function o(e,t){var n=this.exchangeListeners[e];n&&n.forEach(function(e){e(t)})}function s(e){if(e.exchange in this.exchanges){var t=this.exchanges[e.exchange].messageListeners;e.label in t&&t[e.label].forEach(function(t){t(e)})}}var i=1,a=1;local.env.Worker=n,n.prototype.getPort=function(){return this.worker.port?this.worker.port:this.worker},n.prototype.nullify=function(e){this.sendMessage(this.ops,"nullify",e)},n.prototype.importScripts=function(e,t){var n=this.startExchange("importScripts");t&&this.onMessage(n,"done",t),this.sendMessage(n,"urls",e)},n.prototype.terminate=function(){delete this.exchanges,delete this.exchangeListeners,delete this.suspendedTopics,delete this.messageBuffers,this.worker.terminate(),this.worker=null},n.prototype.startExchange=function(t){var n=e();return this.exchanges[n]={topic:t,messageListeners:{},metaData:{}},this.sendMessage(this.ops,"open_exchange",{exchange:n,topic:t}),this.isExchangeTopicSuspended(t)&&this.suspendExchange(n),n},n.prototype.endExchange=function(e){e in this.exchanges&&(s.call(this,{id:t(),exchange:e,label:"close"}),this.sendMessage(e,"close"),this.sendMessage(this.ops,"close_exchange",e),this.removeAllMessageListeners(e),delete this.exchanges[e],e in this.messageBuffers&&delete this.messageBuffers[e])},n.prototype.setExchangeMeta=function(e,t,n){e in this.exchanges&&(this.exchanges[e].metaData[t]=n)},n.prototype.getExchangeMeta=function(e,t){return e in this.exchanges?this.exchanges[e].metaData[t]:null},n.prototype.sendMessage=function(e,n,r){var o;return o="object"==typeof e?e:{id:t(),exchange:e,label:n,data:r},o.exchange in this.messageBuffers?this.messageBuffers[o.exchange].push(o):(this.isLogging&&console.log("sending",o),this.getPort().postMessage(o)),o.id},n.prototype.onExchange=function(e,t){e in this.exchangeListeners||(this.exchangeListeners[e]=[]),this.exchangeListeners[e].push(t)},n.prototype.removeExchangeListener=function(e,t){if(e in this.exchangeListeners){var n=function(e){return e!=t};this.exchangeListeners[e]=this.exchangeListeners[e].filter(n),0===this.exchangeListeners[e].length&&delete this.exchangeListeners[e]}},n.prototype.removeAllExchangeListeners=function(e){e in this.exchangeListeners&&delete this.exchangeListeners[e]},n.prototype.onMessage=function(e,t,n){var r=this.exchanges[e];return r?(t in r.messageListeners||(r.messageListeners[t]=[]),r.messageListeners[t].push(n),void 0):console.error("Invalid `exchange` in onMessage() call: Not a valid ID",e)},n.prototype.removeMessageListener=function(e,t,n){var r=this.exchanges[e];if(!r)return console.warn("Invalid `exchange` in removeMessageListener() call: Not a valid ID",e);if(t in r.messageListeners){var o=function(e){return e!=n};r.messageListeners[t]=r.messageListeners[t].filter(o),0===r.messageListeners[t].length&&delete r.messageListeners[t]}},n.prototype.removeAllMessageListeners=function(e,t){var n=this.exchanges[e];return n?(t?t in n.messageListeners&&delete n.messageListeners[t]:n.messageListeners={},void 0):console.warn("Invalid `exchange` in removeMessageListener() call: Not a valid ID",e)},n.prototype.suspendExchange=function(e){e in this.messageBuffers||(this.messageBuffers[e]=[])},n.prototype.resumeExchange=function(e){if(e in this.messageBuffers){var t=this.messageBuffers[e];delete this.messageBuffers[e],t.forEach(this.sendMessage,this)}},n.prototype.isExchangeSuspended=function(e){return e in this.messageBuffers},n.prototype.suspendExchangeTopic=function(e){if(-1===this.suspendedTopics.indexOf(e)){this.suspendedTopics.push(e);for(var t in this.exchanges)this.exchanges[t].topic==e&&this.suspendExchange(t)}},n.prototype.resumeExchangeTopic=function(e){var t=this.suspendedTopics.indexOf(e);if(-1!==t){this.suspendedTopics.splice(t,1);for(var n in this.exchanges)this.exchanges[n].topic==e&&this.resumeExchange(n)}},n.prototype.isExchangeTopicSuspended=function(e){return-1!==this.suspendedTopics.indexOf(e)}}(),function(){function e(){return r++}function t(){this.config={id:e(),domain:null}}function n(e,r){e=e||{},t.call(this),this.state=n.BOOT,this.canLoadUserscript=!1,this.hasHostPrivileges=!0,this.loadCb=r;for(var o in e)this.config[o]=e[o];this.config.src||(this.config.src=""),this.config.srcBaseUrl||(this.config.srcBaseUrl=/^data/.test(this.config.src)===!1?this.config.src.replace(/\/[^/]+$/,"/"):""),this.config.domain||(this.config.domain="<"+this.config.src.slice(0,40)+">"),this.config.environmentHost=window.location.host,this.worker=new local.env.Worker({bootstrapUrl:local.env.config.workerBootstrapUrl,shared:e.shared||!1,namespace:e.namespace||e.src}),this.worker.suspendExchangeTopic("web_request"),this.worker.suspendExchangeTopic("web_subscribe"),this.worker.onMessage(this.worker.ops,"ready",this.onOpsWorkerReady.bind(this)),this.worker.onMessage(this.worker.ops,"log",this.onOpsWorkerLog.bind(this)),this.worker.onMessage(this.worker.ops,"terminate",this.terminate.bind(this)),this.worker.onExchange("web_request",this.onWebRequestExchange.bind(this)),this.$onWebRequestHeaders=this.onWebRequestHeaders.bind(this),this.$onWebRequestData=this.onWebRequestData.bind(this),this.$onWebRequestEnd=this.onWebRequestEnd.bind(this),this.$onWebResponseHeaders=this.onWebResponseHeaders.bind(this),this.$onWebResponseData=this.onWebResponseData.bind(this),this.$onWebResponseEnd=this.onWebResponseEnd.bind(this),this.$onWebClose=this.onWebClose.bind(this)}var r=1;local.env.Server=t,t.prototype.handleHttpRequest=function(e,t){t.writeHead(0,"server not implemented"),t.end()},t.prototype.terminate=function(){},t.prototype.getSource=function(){return this.handleHttpRequest.toString()},local.env.WorkerServer=n,n.prototype=Object.create(t.prototype),n.BOOT=0,n.READY=1,n.ACTIVE=2,n.DEAD=3,n.prototype.onOpsWorkerReady=function(e){this.hasHostPrivileges=e.data.hostPrivileges,this.hasHostPrivileges&&(this.worker.nullify("XMLHttpRequest"),this.worker.nullify("Worker")),this.state=n.READY,this.canLoadUserscript&&this.loadUserScript()},n.prototype.onOpsWorkerLog=function(e){if(e.data){if(!Array.isArray(e.data))return console.error('Received invalid ops-exchange "log" message: Payload must be an array',e);var t=e.data.shift(),n=["["+this.config.domain+"]"].concat(e.data);switch(t){case"error":console.error.apply(console,n);break;case"warn":console.warn.apply(console,n);break;default:console.log.apply(console,n)}}},n.prototype.terminate=function(){this.state=n.DEAD,this.worker.terminate()},n.prototype.loadUserScript=function(){if(this.canLoadUserscript=!0,this.state==n.READY)if(this.hasHostPrivileges){var e=this.config.src;0===e.indexOf("data:application/javascript,")&&(e="data:application/javacsript;base64,"+btoa(e.slice(28))),this.worker.sendMessage(this.worker.ops,"configure",this.config),this.worker.importScripts(e,this.onWorkerUserScriptLoaded.bind(this))}else this.onWorkerUserScriptLoaded()},n.prototype.onWorkerUserScriptLoaded=function(e){this.loadCb&&"function"==typeof this.loadCb&&this.loadCb(e),e&&e.data.error?(console.error("Failed to load user script in worker, terminating",e,this),this.terminate()):this.state!=n.DEAD&&(this.state=n.ACTIVE,this.worker.resumeExchangeTopic("web_request"),this.worker.resumeExchangeTopic("web_subscribe"))},n.prototype.handleHttpRequest=function(e,t){var n=this.worker,r=n.startExchange("web_request");n.setExchangeMeta(r,"request",e),n.setExchangeMeta(r,"response",t),n.onMessage(r,"response_headers",this.$onWebResponseHeaders),n.onMessage(r,"response_data",this.$onWebResponseData),n.onMessage(r,"response_end",this.$onWebResponseEnd),n.onMessage(r,"close",this.$onWebClose),n.sendMessage(r,"request_headers",e),e.on("data",function(e){n.sendMessage(r,"request_data",e)}),e.on("end",function(){n.sendMessage(r,"request_end")})},n.prototype.getSource=function(e){if(/^data/.test(this.config.src)){var t=this.config.src.indexOf(",");return 0===this.config.src.indexOf("data:application/javascript;base64,")?local.promise(atob(this.config.src.slice(t+1)||"")):local.promise(this.config.src.slice(t+1)||"")}var n={method:"get",url:this.config.src,headers:{accept:"application/javascript"}};return local.web.dispatch(n,e).then(function(e){return e.body},function(e){return console.log("failed to retrieve worker source:",e),""})},n.prototype.onWebRequestExchange=function(e){this.worker.onMessage(e,"request_headers",this.$onWebRequestHeaders),this.worker.onMessage(e,"request_data",this.$onWebRequestData),this.worker.onMessage(e,"request_end",this.$onWebRequestEnd),this.worker.onMessage(e,"close",this.$onWebClose)},n.prototype.onWebRequestHeaders=function(e){if(!e.data)return console.error('Invalid "request_headers" message from worker: Payload missing',e),this.worker.endExchange(e.exchange),void 0;var t=new local.web.Request(e.data);this.worker.setExchangeMeta(e.exchange,"request",t);var n=this.worker;t.stream=!0,local.web.dispatch(t,this).always(function(t){n.setExchangeMeta(e.exchange,"response",t),n.sendMessage(e.exchange,"response_headers",t),t.on("data",function(t){n.sendMessage(e.exchange,"response_data",t)}),t.on("end",function(){n.sendMessage(e.exchange,"response_end")}),t.on("close",function(){n.endExchange(e.exchange)})})},n.prototype.onWebRequestData=function(e){if("string"!=typeof e.data)return console.error('Invalid "request_data" message from worker: Payload must be a string',e),this.worker.endExchange(e.exchange),void 0;var t=this.worker.getExchangeMeta(e.exchange,"request");return t?(t.write(e.data),void 0):(console.error('Invalid "request_data" message from worker: Request headers not previously received',e),this.worker.endExchange(e.exchange),void 0)},n.prototype.onWebRequestEnd=function(e){var t=this.worker.getExchangeMeta(e.exchange,"request");return t?(t.end(),void 0):(console.error('Invalid "request_end" message from worker: Request headers not previously received',e),this.worker.endExchange(e.exchange),void 0)},n.prototype.onWebResponseHeaders=function(e){if(!e.data)return console.error('Invalid "response_headers" message from worker: Payload missing',e),this.worker.endExchange(e.exchange),void 0;var t=this.worker.getExchangeMeta(e.exchange,"response");return t?(t.writeHead(e.data.status,e.data.reason,e.data.headers),void 0):(console.error('Internal error when receiving "response_headers" message from worker: Response object not present',e),this.worker.endExchange(e.exchange),void 0)},n.prototype.onWebResponseData=function(e){if("string"!=typeof e.data)return console.error('Invalid "response_data" message from worker: Payload must be a string',e),this.worker.endExchange(e.exchange),void 0;var t=this.worker.getExchangeMeta(e.exchange,"response");return t?(t.write(e.data),void 0):(console.error('Internal error when receiving "response_data" message from worker: Response object not present',e),this.worker.endExchange(e.exchange),void 0)},n.prototype.onWebResponseEnd=function(e){var t=this.worker.getExchangeMeta(e.exchange,"response");return t?(t.end(),void 0):(console.error('Internal error when receiving "response_end" message from worker: Response object not present',e),this.worker.endExchange(e.exchange),void 0)},n.prototype.onWebClose=function(e){var t=this.worker.getExchangeMeta(e.exchange,"request"),n=this.worker.getExchangeMeta(e.exchange,"response");t&&t.close(),n&&n.close()}}(),function(){function e(e,t){var n=this;if(e||(e={}),!e.sigRelay)throw"`config.sigRelay` is required";local.env.Server.call(this),this.debugname=e.initiate?"A":"B";var r=p.bind(this);this.sigRelay=local.web.navigator(e.sigRelay),this.sigRelay.subscribe({headers:{"last-event-id":-1}}).then(function(e){n.state.signaling=!0,n.sigRelayStream=e,e.on("message",r)}),this.sigRelayStream=null;var o=b;e.iceServers&&(o=e.iceServers.concat(o)),this.peerConn=new webkitRTCPeerConnection(o,m),this.peerConn.onicecandidate=v.bind(this),this.reqChannel=this.peerConn.createDataChannel("requestChannel",{reliable:!1}),l.call(this),this.chanOpenCb=t,this.__offerOnReady=!!e.initiate,this.__isOfferExchanged=!1,this.__candidateQueue=[],this.__ridcounter=1,this.__incomingRequests={},this.__incomingResponses={},this.__reqChannelBuffer={},this.state={alive:!0,signaling:!1,connected:!1},this.signal({type:"ready"})}function t(e,t){var r=this,o=n.call(this),s="httpl://"+r.config.domain+"/",i=decodeURIComponent(e.path.slice(1)),a=local.web.parseUri(i),l=a.authority?a.protocol+"://"+a.authority:s,c=new local.web.Request(e);c.url=i,c.headers.via=c.headers.via?c.headers.via.concat(o):[o],c.stream=!0,this.peerDispatch(c).always(function(e){e.headers.link&&e.headers.link.forEach(function(e){var t=local.web.parseUri(e.href);t.host||(e.href=l+e.href),e.href=s+e.href}),e.headers.via=e.headers.via?e.headers.via.concat(o):[o],t.writeHead(e.status,e.reason,e.headers),e.on("data",t.write.bind(t)),e.on("end",t.end.bind(t))}),e.on("data",c.write.bind(c)),e.on("end",c.end.bind(c))}function n(){return{protocol:{name:"httpl",version:"0.4"},host:this.config.domain,comment:"Grimwire/0.2"}}function r(e){this.debugLog("REQ CHANNEL RELIABLE MSG",e);var t=i(e);t&&a.call(this,t,function(){t[0]>0?o.apply(this,t):s.apply(this,t)})}function o(e,t,n,r){var o,s=this.reqChannelReliable;if("h"==n){try{o=JSON.parse(r)}catch(i){return console.warn("RTCPeerServer - Unparseable request headers message from peer",e,n,r)}o.stream=!0,o=new local.web.Request(o),local.web.dispatch(o,this).always(function(t){var n=-e,r=0;s.send(n+":"+r++ +":h:"+JSON.stringify(t)),t.on("data",function(e){s.send(n+":"+r++ +":d:"+e)}),t.on("end",function(){s.send(n+":"+r++ +":e")}),t.on("close",function(){s.send(n+":"+r++ +":c")})}),this.__incomingRequests[e]=o}else{if(o=this.__incomingRequests[e],!o)return console.warn("RTCPeerServer - Invalid request id",e,n,r);switch(n){case"d":o.write(r);break;case"e":o.end();break;case"c":o.close(),delete this.__incomingRequests[e],delete this.__reqChannelBuffer[e];break;default:console.warn("RTCPeerServer - Unrecognized message from peer",e,n,r)}}}function s(e,t,n,r){var o=this.__incomingResponses[e];if(!o)return console.warn("RTCPeerServer - Invalid response id",e,n,r);switch(n){case"h":try{r=JSON.parse(r)}catch(s){return console.warn("RTCPeerServer - Unparseable response headers message from peer",e,n,r)}o.writeHead(r.status,r.reason,r.headers);
break;case"d":o.write(r);break;case"e":o.end();break;case"c":o.close(),delete this.__incomingResponses[e],delete this.__reqChannelBuffer[e];break;default:console.warn("RTCPeerServer - Unrecognized message from peer",e,n,r)}}function i(e){var t=w.exec(e);if(!t)return console.warn("RTCPeerServer - Unparseable message from peer",e),null;var n=[parseInt(t[1],10),parseInt(t[2],10),t[3]];return t[4]&&n.push(t[4].slice(1)),n}function a(e,t){var n=e[0],r=e[1],o=this.__reqChannelBuffer[n];if(o||(o=this.__reqChannelBuffer[n]={nextmid:0,cbs:{}}),r>o.nextmid)o.cbs[r]=t,this.debugLog("REQ CHANNEL MSG OoO, BUFFERING",e);else for(t.call(this),o.nextmid++;o.cbs[o.nextmid];)this.debugLog("REQ CHANNEL DRAINING OoO MSG",o.nextmid),o.cbs[o.nextmid].call(this),delete o.cbs[o.nextmid],o.nextmid++}function l(){this.reqChannelReliable=new Reliable(this.reqChannel),this.reqChannel.onopen=c.bind(this),this.reqChannel.onclose=u.bind(this),this.reqChannel.onerror=h.bind(this),this.reqChannelReliable.onmessage=r.bind(this)}function c(e){this.debugLog("REQ CHANNEL OPEN",e),this.state.connected=!0,"function"==typeof this.chanOpenCb&&this.chanOpenCb()}function u(e){this.debugLog("REQ CHANNEL CLOSE",e)}function h(e){this.debugLog("REQ CHANNEL ERR",e)}function p(e){var t=this,n=e.event,r=e.data;if(r&&"object"!=typeof r)return console.warn("RTCPeerServer - Unparseable signal message from"+n,e),void 0;switch(r.type){case"ready":this.__offerOnReady&&f.call(this);break;case"closed":d.call(this);break;case"candidate":this.debugLog("GOT CANDIDATE",r.candidate),this.__isOfferExchanged?this.peerConn.addIceCandidate(new RTCIceCandidate({candidate:r.candidate})):this.__candidateQueue.push(r.candidate);break;case"offer":this.debugLog("GOT OFFER",r),this.peerConn.setRemoteDescription(new RTCSessionDescription(r)),g.call(t),this.peerConn.createAnswer(function(e){t.debugLog("CREATED ANSWER",e),e.sdp=Reliable.higherBandwidthSDP(e.sdp),t.peerConn.setLocalDescription(e),t.signal({type:"answer",sdp:e.sdp})},null,y);break;case"answer":this.debugLog("GOT ANSWER",r),this.peerConn.setRemoteDescription(new RTCSessionDescription(r)),g.call(t);break;default:console.warn("RTCPeerServer - Unrecognized signal message from"+n,e)}}function f(){var e=this;this.peerConn.createOffer(function(t){e.debugLog("CREATED OFFER",t),t.sdp=Reliable.higherBandwidthSDP(t.sdp),e.peerConn.setLocalDescription(t),e.signal({type:"offer",sdp:t.sdp})},null,y)}function d(){this.signal({type:"closed"}),this.state.alive=!1,this.state.signaling=!1,this.state.connected=!1,this.sigRelayStream&&this.sigRelayStream.close(),this.peerConn&&this.peerConn.close()}function g(){var e=this;this.__isOfferExchanged=!0,this.__candidateQueue.forEach(function(t){e.peerConn.addIceCandidate(new RTCIceCandidate({candidate:t}))}),this.__candidateQueue.length=0}function v(e){e&&e.candidate&&(this.debugLog("FOUND ICE CANDIDATE",e.candidate),this.signal({type:"candidate",candidate:e.candidate.candidate}))}var m={optional:[{RtpDataChannels:!0}]},y={optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}},b={iceServers:[{url:"stun:stun.l.google.com:19302"}]};local.env.RTCPeerServer=e,e.prototype=Object.create(local.env.Server.prototype),e.prototype.debugLog=function(){var e=[this.debugname].concat([].slice.call(arguments));console.debug.apply(console,e)},e.prototype.handleHttpRequest=function(e,n){this.debugLog("HANDLING REQUEST",e),"/"==e.path?(n.setHeader("link",[{href:"/",rel:"self service via"},{href:"/{id}",rel:"http://grimwire.com/rel/proxy"}]),"GET"==e.method?n.writeHead(200,"ok",{"content-type":"application/json"}).end(this.state):"HEAD"==e.method?n.writeHead(200,"ok").end():n.writeHead(405,"bad method").end()):t.call(this,e,n)},e.prototype.terminate=function(){d.call(this)},e.prototype.peerDispatch=function(e){var t=this.__ridcounter++,n=-t,r=local.promise(),o=new local.web.Response;if(o.on("headers",function(e){local.web.fulfillResponsePromise(r,e)}),this.__incomingResponses[n]=o,this.state.connected){var s=0,i=this.reqChannelReliable;i.send(t+":"+s++ +":h:"+JSON.stringify(e)),e.on("data",function(e){i.send(t+":"+s++ +":d:"+e)}),e.on("end",function(){i.send(t+":"+s++ +":e")}),e.on("close",function(){i.send(t+":"+s++ +":c")})}else setTimeout(function(){o.writeHead(504,"gateway timeout").end()},0);return r};var w=/([\-\d]+):([\-\d]+):(.)(:.*)?/;e.prototype.signal=function(e){this.sigRelay.dispatch({method:"notify",headers:{authorization:this.sigRelay.authHeader,"content-type":"application/json"},body:e}).then(null,function(e){console.warn("RTCPeerServer - Failed to send signal message to relay",e)})}}(),local.env.config={workerBootstrapUrl:"worker.min.js"},local.env.servers={},local.env.clientRegions={},local.env.numServers=0,local.env.numClientRegions=0,local.env.addServer=function(e,t){return t.config.domain=e,local.env.servers[e]=t,local.env.numServers++,t.loadUserScript&&t.loadUserScript(),local.web.registerLocal(e,t.handleHttpRequest,t),t},local.env.killServer=function(e){var t=local.env.servers[e];t&&(local.web.unregisterLocal(e),t.terminate(),delete local.env.servers[e],local.env.numServers--)},local.env.getServer=function(e){return local.env.servers[e]},local.env.listFilteredServers=function(e){var t={};for(var n in local.env.servers)e(local.env.servers[n],n)&&(t[n]=local.env.servers[n]);return t},local.env.addClientRegion=function(e){var t;return"object"==typeof e?t=e.id:(t=e,e=new local.client.Region(t)),local.env.clientRegions[e.id]=e,local.env.numClientRegions++,e},local.env.removeClientRegion=function(e){local.env.clientRegions[e]&&(local.env.clientRegions[e].terminate(),delete local.env.clientRegions[e],local.env.numClientRegions--)},local.env.getClientRegion=function(e){return local.env.clientRegions[e]};var e;local.web.setDispatchWrapper(function(t,n,r,o){var s=local.web.parseUri(t.url);if(s.query){var i=local.web.contentTypes.deserialize(s.query,"application/x-www-form-urlencoded");for(var a in i)t.query[a]=i[a];delete s.query,s.relative=s.path+(s.anchor?"#"+s.anchor:""),t.url=s.protocol+"://"+s.authority+s.relative}t.urld=s,e.call(null,t,n,r,o)}),local.env.setDispatchWrapper=function(t){e=t},local.env.setDispatchWrapper(function(e,t,n){return n(e,t)});var t=function(){};local.env.postProcessRegion=function(e,n){return t(e,n)},local.env.setRegionPostProcessor=function(e){t=e}}();